<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>45ç å¤§æ±—è„šå¸¦æ´¾èŠå¤©å®¤</title>
  <style>
    :root { --primary:#25b7c4; --bg:#f6f9fc; }
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{ margin:0; background:linear-gradient(135deg,#eaf7ff,#fff); font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Microsoft Yahei",sans-serif; }
    .wrap{ height:100vh; display:grid; grid-template-rows:auto 1fr auto; }
    .header{ display:flex; align-items:center; justify-content:space-between; padding:10px 16px; background:#fff; border-bottom:1px solid #e5e7eb; }
    .brand{ font-weight:600; color:#0f172a; }
    .user{ color:#334155; font-size:14px; }
    .main{ display:grid; grid-template-columns:280px 1fr; height:100%; overflow:hidden; min-height:0; }
    .sidebar{ background:#f8fafc; border-right:1px solid #e5e7eb; padding:12px; overflow:hidden; }
    .room-title{ font-size:14px; color:#334155; margin-bottom:8px; }
    .contacts{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; font-size:14px; color:#0f172a; }
    .contact{ background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:8px 10px; }
    .content{ background:#fff; display:flex; flex-direction:column; min-height:0; overflow:hidden; }
    .messages{ flex:1 1 auto; overflow-y:auto; padding:16px; display:flex; flex-direction:column; justify-content:flex-start; gap:8px; min-height:0; }
    .messages::-webkit-scrollbar{ width:8px; }
    .messages::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:4px; }
    .bubble{ max-width:70%; padding:10px 12px; margin:8px 0; border-radius:14px; box-shadow:0 2px 6px rgba(0,0,0,.06); display:inline-block; font-size:14px; }
    .me{ background:#dcfce7; margin-left:auto; }
    .other{ background:#f1f5f9; }
    .system{ background:#fee2e2; color:#b91c1c; }
    .inputbar{ display:flex; gap:8px; padding:10px; border-top:1px solid #e5e7eb; align-items:center; flex-shrink:0; }
    .emoji-btn{ width:36px; height:36px; border:none; border-radius:50%; background:#eef2ff; color:#0f172a; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .emoji-btn:hover{ background:#e0e7ff; }
    .text{ flex:1; padding:10px 12px; border:1px solid #e2e8f0; border-radius:10px; outline:none; font-size:14px; }
    .text:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,183,196,.18); }
    .btn{ padding:10px 14px; border:none; border-radius:10px; background:var(--primary); color:#fff; cursor:pointer; }
    .emoji-panel{ position:relative; }
    .emoji-list{ position:absolute; bottom:46px; left:0; background:#fff; border:1px solid #e2e8f0; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:8px; display:none; gap:6px; z-index:10; }
    .emoji-list button{ width:32px; height:32px; border:none; background:#f1f5f9; border-radius:8px; cursor:pointer; }
    .emoji-list button:hover{ background:#e2e8f0; }
    /* åº•éƒ¨å·¥å…·æ å›ºå®šï¼šä¸éšæ¶ˆæ¯æ»šåŠ¨ */
    .tagbar{ display:flex; gap:8px; padding:8px 12px; border-top:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; background:#f8fafc; flex-wrap:wrap; flex-shrink:0; }
    .tag{ padding:6px 10px; border-radius:999px; border:1px solid #cbd5e1; background:#fff; color:#0f172a; font-size:13px; cursor:pointer; }
    .tag:hover{ background:#f1f5f9; }
    .footer{ background:#fff; border-top:1px solid #e5e7eb; padding:8px 12px; font-size:12px; color:#64748b; display:flex; justify-content:space-between; }
    @media (max-width: 900px){ .main{ grid-template-columns: 1fr; } .sidebar{ display:none; } }
  </style>
</head>
<body data-nickname="{{ nickname }}" data-server="{{ server }}">
  <div class="wrap">
    <div class="header">
      <div class="brand">45ç å¤§æ±—è„šå¸¦æ´¾èŠå¤©å®¤ Â· v0.2</div>
      <div class="user">æ¬¢è¿ï¼Œ{{ nickname }}ï½œ<a href="/logout">é€€å‡º</a></div>
    </div>
    <div class="main">
      <aside class="sidebar">
        <div class="room-title">è”ç³»äºº</div>
        <ul id="contacts" class="contacts"></ul>
      </aside>
      <section class="content">
        <div id="messages" class="messages"></div>
        <!-- å¯è§çš„ @ åŠŸèƒ½æ ‡ç­¾æ ï¼Œç‚¹å‡»å³åœ¨è¾“å…¥æ¡†æ’å…¥å¯¹åº”æ ‡ç­¾ -->
        <div class="tagbar">
          <button class="tag" onclick="insertAt('@æˆå°ç†')">@æˆå°ç†</button>
          <button class="tag" onclick="insertAt('@éŸ³ä¹ä¸€ä¸‹')">@éŸ³ä¹ä¸€ä¸‹</button>
          <button class="tag" onclick="insertAt('@ç”µå½±')">@ç”µå½±</button>
          <button class="tag" onclick="insertAt('@å¤©æ°”')">@å¤©æ°”</button>
          <button class="tag" onclick="insertAt('@æ–°é—»')">@æ–°é—»</button>
          <button class="tag" onclick="insertAt('@å°è§†é¢‘')">@å°è§†é¢‘</button>
        </div>
        <div class="inputbar">
          <div class="emoji-panel">
            <button id="emojiBtn" class="emoji-btn" title="è¡¨æƒ…">ğŸ˜€</button>
            <div id="emojiList" class="emoji-list">
              <button onclick="insertEmoji('ğŸ˜€')">ğŸ˜€</button>
              <button onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</button>
              <button onclick="insertEmoji('ğŸ‘')">ğŸ‘</button>
              <button onclick="insertEmoji('â¤ï¸')">â¤ï¸</button>
              <button onclick="insertEmoji('ğŸ‰')">ğŸ‰</button>
              <button onclick="insertEmoji('ğŸ€')">ğŸ€</button>
            </div>
          </div>
          <input id="msgInput" class="text" placeholder="éšä¾¿èŠç‚¹å•¥å§ï¼Œæ”¯æŒğŸ˜€ï¼Œæ”¯æŒ@åŠŸèƒ½æ ‡ç­¾â€¦" />
          <button id="sendBtn" class="btn">å‘é€</button>
        </div>
      </section>
    </div>
    <div class="footer">ä»…æ¶ˆæ¯åŒºå…è®¸æ»šåŠ¨æ¡ï¼Œå…¶å®ƒåŒºåŸŸä¸å‡ºç°æ»šåŠ¨æ¡ï¼›åŠŸèƒ½å·²æ•´åˆä¼˜åŒ–ã€‚</div>
  </div>

  <!-- åŠ¨æ€åŠ è½½ Socket.IO å®¢æˆ·ç«¯ï¼šä¼˜å…ˆåç«¯é»˜è®¤è·¯å¾„ï¼Œå…¶æ¬¡æœ¬åœ° /staticï¼Œå†å›é€€åˆ°å¤šæº CDN -->
  <script>
    function loadSocketIo(done){
      const tryLoad = (src, next) => {
        const s = document.createElement('script');
        s.src = src;
        s.onload = () => done();
        s.onerror = () => next ? next() : done(new Error('load failed'));
        document.head.appendChild(s);
      };
      // ä¸ºä¿è¯â€œèƒ½æ‰“å¼€â€ï¼Œæ”¹ä¸º CDN ä¼˜å…ˆ â†’ æœ¬åœ°é™æ€ â†’ æœåŠ¡ç«¯
      tryLoad('https://cdn.socket.io/4.7.2/socket.io.min.js', () => {
        tryLoad('https://cdn.jsdelivr.net/npm/socket.io-client@4.7.2/dist/socket.io.min.js', () => {
          tryLoad('/static/js/socket.io.min.js', () => {
            tryLoad('/socket.io/socket.io.js', () => done(new Error('all sources failed')));
          });
        });
      });
    }
    // å…¼å®¹æœªç»è¿‡æ¨¡æ¿æ¸²æŸ“çš„é™æ€é¢„è§ˆï¼šä» data-* è¯»å–ï¼Œé¿å…åŒèŠ±æ‹¬å·é€ æˆè¯­æ³•é”™è¯¯
    const nickname = document.body.dataset.nickname || 'æ¸¸å®¢';
    const server = document.body.dataset.server || '';
    let socket;
    let unavailableShown = false;
    // ---------- AI ä»»åŠ¡ç®¡ç†ï¼ˆå…¨å±€ï¼‰ ----------
    window.currentAiTask = null;
    function setActive(obj){ window.currentAiTask = obj; }
    function clearActive(){ window.currentAiTask = null; }
    function cancelActiveAi(){
      const t = window.currentAiTask;
      if(t && typeof t.cancel === 'function'){
        try{ t.cancel(); }catch(_){ }
      }
      window.currentAiTask = null;
    }

    function connect(){
      if(typeof io === 'undefined'){
        appendMessage({ nickname:'ç³»ç»Ÿ', message:'Socket å®¢æˆ·ç«¯æœªåŠ è½½', timestamp:new Date().toLocaleTimeString(), system:true });
        return;
      }
      // æ˜¾å¼æŒ‡å®š Socket.IO è·¯å¾„ï¼›ç»Ÿä¸€è¿æ¥åˆ°å½“å‰é¡µé¢æº
      // æ”¾å®½ä¼ è¾“æ–¹å¼ä»¥é€‚é…å…¬ç½‘éš§é“ï¼ˆè‹¥ websocket ä¸å¯ç”¨åˆ™å›é€€ä¸º pollingï¼‰
      const opts = {
        path:'/socket.io',
        // å¼ºåˆ¶ä½¿ç”¨è½®è¯¢ï¼Œç¦ç”¨å‡çº§ï¼Œä»¥é€‚é…å…¬ç½‘/å—é™ç½‘ç»œ
        transports:['polling'],
        upgrade:false,
        reconnection:true,
        reconnectionAttempts:5,
        reconnectionDelay:800,
        timeout:5000,
        forceNew:true,
        rememberUpgrade:false
      };
      const target = window.location.origin;
      try {
        socket = io(target, opts);
      } catch(e) {
        // åŸåŸŸåˆå§‹åŒ–å¤±è´¥æ—¶ï¼Œå°è¯•ç”¨æˆ·é€‰æ‹©çš„æœåŠ¡å™¨åœ°å€
        if(server){
          try{ socket = io(new URL(server).origin, opts); }catch(_){ }
        }
      }
      if(!socket){
        appendMessage({ nickname:'ç³»ç»Ÿ', message:'æœåŠ¡ä¸å¯ç”¨', timestamp:new Date().toLocaleTimeString(), system:true });
        return;
      }
      socket.on('connect', () => {
        socket.emit('join', { nickname });
      });
      socket.on('receive_message', (data) => {
        appendMessage(data);
        // åœ¨æ”¶åˆ°è‡ªå·±çš„æ¶ˆæ¯å›æ˜¾åå†è§¦å‘ç›¸å…³åŠŸèƒ½ï¼Œä¿è¯æ°”æ³¡é¡ºåº
        if(data && data.nickname === nickname){
          if(data.message && data.message.includes('@æˆå°ç†')){
            startAiStream(data.message, 500);
          }
          if(data.message && data.message.includes('@å¤©æ°”')){
            startWeather(data.message);
          }
          if(data.message && data.message.includes('@æ–°é—»')){
            startNews();
          }
          if(data.message && data.message.includes('@å°è§†é¢‘')){
            startShortVideo();
          }
          if(data.message && (
            /@éŸ³ä¹(?:ä¸€ä¸‹)?\s*æœç´¢\s+/i.test(data.message) ||
            /@éŸ³ä¹(?:ä¸€ä¸‹)?\s*æ­Œæ‰‹\s+/i.test(data.message) ||
            /@éŸ³ä¹(?:ä¸€ä¸‹)?\s*æ­Œå\s+/i.test(data.message) ||
            /@éŸ³ä¹ä¸€ä¸‹\s+(?!https?:\/\/)/i.test(data.message) // ç®€åŒ–è¯­æ³•ï¼š@éŸ³ä¹ä¸€ä¸‹ å…³é”®è¯ï¼ˆéURLï¼‰
          )){
            startMusicSearch(data.message);
          }
        }
      });
      socket.on('system_message', (data) => {
        appendMessage({ nickname:'ç³»ç»Ÿ', message: data.message, timestamp: data.timestamp, system:true });
      });
      socket.on('user_list', (list) => { updateContacts(list); });

      // è¿æ¥å¤±è´¥æˆ–é‡è¿å¤±è´¥æ—¶ï¼Œæ˜¾ç¤ºâ€œæœåŠ¡ä¸å¯ç”¨â€ç³»ç»Ÿæç¤º
      const showUnavailable = () => {
        if(unavailableShown) return;
        unavailableShown = true;
        appendMessage({ nickname:'ç³»ç»Ÿ', message:'æœåŠ¡ä¸å¯ç”¨', timestamp:new Date().toLocaleTimeString(), system:true });
      };
      socket.on('connect_error', showUnavailable);
      socket.on('reconnect_error', showUnavailable);
      socket.on('reconnect_failed', showUnavailable);
      socket.on('disconnect', () => {
        appendMessage({ nickname:'ç³»ç»Ÿ', message:'å·²ä¸æœåŠ¡å™¨æ–­å¼€', timestamp:new Date().toLocaleTimeString(), system:true });
      });
    }

    function updateContacts(list){
      const ul = document.getElementById('contacts');
      ul.innerHTML = '';
      (list || []).forEach(name => {
        const li = document.createElement('li');
        li.className = 'contact';
        li.textContent = name;
        ul.appendChild(li);
      });
    }

    function appendMessage({nickname: name, message, timestamp, system}){
      const box = document.getElementById('messages');
      const div = document.createElement('div');
      const cls = system ? 'system' : (name === nickname ? 'me' : 'other');
      div.className = `bubble ${cls}`;

      // è§£æ @ç”µå½± å¹¶æ’å…¥ iframeï¼šæ”¯æŒ @ç”µå½±[url] æˆ– @ç”µå½± url ä¸¤ç§æ ¼å¼
      let movieUrl = null;
      if(!system && message && message.includes('@ç”µå½±')){
        const m = message.match(/@ç”µå½±\s*(?:\[(.*?)\]|(https?:\/\/\S+))/i);
        if(m){
          movieUrl = (m[1] || m[2] || '').trim();
        }
      }
      if(!system && movieUrl){
        const header = document.createElement('div');
        header.textContent = `${name} ${timestamp}`;
        const iframe = document.createElement('iframe');
        iframe.width = 400;
        iframe.height = 400;
        iframe.style.border = 'none';
        iframe.setAttribute('allowfullscreen', 'true');
        iframe.src = `https://jx.m3u8.tv/jiexi/?url=${encodeURIComponent(movieUrl)}`;
        div.appendChild(header);
        div.appendChild(iframe);
      }else{
        // è§£æ @éŸ³ä¹/éŸ³ä¹ä¸€ä¸‹ å¹¶æ’å…¥ audioï¼šæ”¯æŒ @éŸ³ä¹[url] æˆ– @éŸ³ä¹ urlï¼Œä¸¤è€…éƒ½å¯
        let musicUrl = null;
        if(!system && message && (message.includes('@éŸ³ä¹') || message.includes('@éŸ³ä¹ä¸€ä¸‹'))){
          const mm = message.match(/@éŸ³ä¹(?:ä¸€ä¸‹)?\s*(?:\[(.*?)\]|(https?:\/\/\S+))/i);
          if(mm){
            musicUrl = (mm[1] || mm[2] || '').trim();
          }
        }
        if(!system && musicUrl){
          const header = document.createElement('div');
          header.textContent = `${name} ${timestamp}`;
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.style.width = '100%';
          audio.src = musicUrl;
          div.appendChild(header);
          div.appendChild(audio);
        }else{
          div.innerText = `${name} ${timestamp}\n${message}`;
        }
      }

      box.appendChild(div);
      box.scrollTop = box.scrollHeight; // ä»…æ¶ˆæ¯åŒºæ»šåŠ¨
    }

    // æ—§çš„ featurebar åŠŸèƒ½æš‚æ—¶ç§»é™¤ï¼Œå¦‚éœ€å†å²è®°å½•ç­‰å…¥å£ï¼Œå¯åœ¨å³ä¸Šè§’å†åŠ æŒ‰é’®
    function insertEmoji(e){
      const inp = document.getElementById('msgInput');
      inp.value += e;
      inp.focus();
    }
    function insertAt(tag){
      const inp = document.getElementById('msgInput');
      inp.value += (tag + ' ');
      inp.focus();
    }

    function send(){
      const val = document.getElementById('msgInput').value.trim();
      if(!val) return;
      if(!socket){
        appendMessage({ nickname:'ç³»ç»Ÿ', message:'æœåŠ¡ä¸å¯ç”¨', timestamp:new Date().toLocaleTimeString(), system:true });
        return;
      }
      socket.emit('send_message', { nickname, message: val });
      document.getElementById('msgInput').value = '';
      // ç›¸å…³åŠŸèƒ½çš„è§¦å‘æ”¹ä¸ºåœ¨ receive_message å›è°ƒä¸­æ‰§è¡Œï¼Œé¿å…é¡ºåºé”™ä¹±
    }

    document.getElementById('sendBtn').addEventListener('click', send);
    document.getElementById('msgInput').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ send(); }
    });
    // Emoji é¢æ¿å¼€å…³
    document.getElementById('emojiBtn').addEventListener('click', ()=>{
      const panel = document.getElementById('emojiList');
      panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
    });

    loadSocketIo((err)=>{
      if(err || typeof io === 'undefined'){
        appendMessage({ nickname:'ç³»ç»Ÿ', message:'Socket å®¢æˆ·ç«¯æœªåŠ è½½', timestamp:new Date().toLocaleTimeString(), system:true });
        return;
      }
      connect();
    });

    // ---------- AI SSE ----------
    function startAiStream(prompt, delayMs = 500){
      // æŠ¢å ï¼šè‹¥æœ‰è¿›è¡Œä¸­çš„ç”Ÿæˆï¼Œåˆ™ç«‹å³ä¸­æ–­ï¼Œå¼€å§‹æ–°çš„
      cancelActiveAi();
      const box = document.getElementById('messages');
      setTimeout(()=>{
        const div = document.createElement('div');
        div.className = 'bubble other';
        const ts = new Date().toLocaleTimeString();
        div.innerText = `æˆå°ç† ${ts}\n`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;

        const base = window.location.origin;
        const url = `${base}/ai/stream?q=${encodeURIComponent(prompt)}`;
        const urlComplete = `${base}/ai/complete?q=${encodeURIComponent(prompt)}`;
        let acc = '';
        let es;
        let reader = null;
        let fetchCtrl = null;
        // ä»»åŠ¡ç®¡ç†å‡½æ•°å·²åœ¨å…¨å±€å®šä¹‰
        function update(text){
          acc += text;
          div.innerText = `æˆå°ç† ${ts}\n${acc}`;
          box.scrollTop = box.scrollHeight;
        }
        function end(){ /* no-op */ }
        async function fail(){
          // æœ€ç»ˆå›é€€ï¼šéæµå¼ä¸€æ¬¡æ€§è¿”å›
          try{
            const ctrl = new AbortController();
            setActive({ mode:'complete', cancel: ()=>{ try{ ctrl.abort(); }catch(_){ } } });
            const r = await fetch(urlComplete, { signal: ctrl.signal });
            const j = await r.json();
            if(j && j.ok && j.text){
              update(j.text);
              clearActive();
              return;
            }
          }catch(_){ }
          clearActive();
          appendMessage({ nickname:'ç³»ç»Ÿ', message:'AIæœåŠ¡ä¸å¯ç”¨ï¼ˆSSEè¿æ¥é”™è¯¯ï¼Œå·²å°è¯•å›é€€ï¼‰', timestamp:new Date().toLocaleTimeString(), system:true });
        }
        // å›é€€ï¼šä½¿ç”¨ fetch + ReadableStream è§£æ SSE
        async function streamViaFetch(url){
          try{
            fetchCtrl = new AbortController();
            setActive({ mode:'fetch', cancel: ()=>{
              try{ fetchCtrl.abort(); }catch(_){ }
              try{ if(reader) reader.cancel(); }catch(_){ }
            }});
            const res = await fetch(url, { headers: { 'Accept':'text/event-stream' }, signal: fetchCtrl.signal });
            if(!res || !res.ok || !res.body){ throw new Error('bad response'); }
            reader = res.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buf = '';
            while(true){
              const { value, done } = await reader.read();
              if(done) break;
              buf += decoder.decode(value, { stream:true });
              // è§£ææŒ‰ \n\n åˆ†éš”çš„SSEå—
              let idx;
              while((idx = buf.indexOf('\n\n')) !== -1){
                const chunk = buf.slice(0, idx);
                buf = buf.slice(idx + 2);
                const m = chunk.match(/^data:\s*(.*)$/m);
                if(!m) continue;
                const data = m[1];
                if(data === '[DONE]'){ end(); return; }
                update(data);
              }
            }
            clearActive();
          }catch(e){ fail(); }
        }
        try{
          es = new EventSource(url);
          setActive({ mode:'sse', cancel: ()=>{ try{ es.close(); }catch(_){ } } });
          es.onmessage = (ev)=>{
            if(ev.data === '[DONE]'){
              es.close();
              clearActive();
              return;
            }
            update(ev.data);
          };
          es.onerror = ()=>{
            try{ es.close(); }catch(_){ }
            streamViaFetch(url); // è‡ªåŠ¨å›é€€
          };
        }catch(e){
          // åˆå§‹åŒ–å¤±è´¥ç›´æ¥å›é€€
          streamViaFetch(url);
        }
      }, delayMs);
    }

    // ---------- Weather Query ----------
    function startWeather(message){
      const box = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'bubble other';
      const ts = new Date().toLocaleTimeString();
      div.innerText = `ç³»ç»Ÿ ${ts}\nå¤©æ°”æŸ¥è¯¢ä¸­â€¦`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;

      const base = window.location.origin;
      const url = `${base}/feature/weather?q=${encodeURIComponent(message)}`;
      fetch(url).then(r=>r.json()).then(j=>{
        if(j && j.ok){
          div.innerText = `ç³»ç»Ÿ ${ts}\n${j.text}`;
        }else{
          const err = (j && j.error) ? j.error : 'å¤©æ°”æŸ¥è¯¢å¤±è´¥';
          div.innerText = `ç³»ç»Ÿ ${ts}\n${err}`;
        }
        box.scrollTop = box.scrollHeight;
      }).catch(()=>{
        div.innerText = `ç³»ç»Ÿ ${ts}\nå¤©æ°”æœåŠ¡ä¸å¯ç”¨`;
        box.scrollTop = box.scrollHeight;
      });
    }

    // ---------- Music Search ----------
    function startMusicSearch(message){
      // è§£æä¸‰ç§è¯­æ³•ï¼š
      // 1) @éŸ³ä¹ æœç´¢ å…³é”®è¯
      // 2) @éŸ³ä¹ä¸€ä¸‹ æ­Œæ‰‹ åç§°
      // 3) @éŸ³ä¹ä¸€ä¸‹ æ­Œå æ ‡é¢˜ï¼ˆå¯é€‰ + æ­Œæ‰‹ æˆ– å«â€œæ­Œæ‰‹ åç§°â€ï¼‰
      let mode = 'search';
      let keyword = '';
      let artist = '';
      let title = '';
      let m;
      if((m = message.match(/@éŸ³ä¹(?:ä¸€ä¸‹)?\s*æœç´¢\s+(.+)$/i))){
        mode = 'search';
        keyword = m[1].trim();
      }else if((m = message.match(/@éŸ³ä¹(?:ä¸€ä¸‹)?\s*æ­Œæ‰‹\s+(.+)$/i))){
        mode = 'artist';
        artist = m[1].trim();
      }else if((m = message.match(/@éŸ³ä¹(?:ä¸€ä¸‹)?\s*æ­Œå\s+(.+)$/i))){
        mode = 'song';
        let rest = m[1].trim();
        // æ”¯æŒ â€œæ­Œå XXX + æ­Œæ‰‹ YYYâ€ æˆ– â€œæ­Œå XXX æ­Œæ‰‹ YYYâ€
        const byPlus = rest.split(/\s*\+\s*/);
        if(byPlus.length === 2){
          title = byPlus[0].trim();
          artist = byPlus[1].replace(/^æ­Œæ‰‹\s+/, '').trim();
        }else{
          const m2 = rest.match(/^(.*?)\s+æ­Œæ‰‹\s+(.+)$/);
          if(m2){
            title = m2[1].trim();
            artist = m2[2].trim();
          }else{
            title = rest;
          }
        }
      }else if((m = message.match(/@éŸ³ä¹ä¸€ä¸‹\s+(.+)$/i))){
        // ç®€åŒ–è¯­æ³•ï¼š@éŸ³ä¹ä¸€ä¸‹ å…³é”®è¯ => åç«¯è‡ªåŠ¨æ¨¡å¼ï¼ŒåŒæ—¶æŒ‰æ­Œå/æ­Œæ‰‹ä¸¤ç§ attribute æ£€ç´¢
        const rest = m[1].trim();
        // è‹¥æ˜¯ URLï¼Œäº¤ç”±ä¸Šæ¸¸çš„ç›´æ¥æ’­æ”¾é€»è¾‘å¤„ç†ï¼Œè¿™é‡Œä¸è§¦å‘æœç´¢
        if(/^https?:\/\//i.test(rest)){
          return;
        }
        mode = 'auto';
        keyword = rest;
      }
      const box = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'bubble other';
      const ts = new Date().toLocaleTimeString();
      div.innerText = `ç³»ç»Ÿ ${ts}\néŸ³ä¹æœç´¢ä¸­â€¦`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;

      const base = window.location.origin;
      let url = `${base}/feature/music/search`;
      if(mode === 'artist'){
        url += `?mode=artist&artist=${encodeURIComponent(artist)}`;
      }else if(mode === 'song'){
        const params = new URLSearchParams({ mode:'song', title });
        if(artist) params.set('artist', artist);
        url += `?${params.toString()}`;
      }else if(mode === 'auto'){
        url += `?mode=auto&q=${encodeURIComponent(keyword)}`;
      }else{
        url += `?q=${encodeURIComponent(keyword)}`;
      }
      fetch(url).then(r=>r.json()).then(j=>{
        if(j && j.ok){
          const list = j.results || [];
          const frag = document.createDocumentFragment();
          const header = document.createElement('div');
          header.textContent = `ç³»ç»Ÿ ${ts}`;
          frag.appendChild(header);
          list.forEach(item => {
            const row = document.createElement('div');
            row.style.display = 'grid';
            row.style.gridTemplateColumns = '60px 1fr';
            row.style.gap = '8px';
            row.style.alignItems = 'center';

            const img = document.createElement('img');
            img.src = item.artworkUrl100 || '';
            img.style.width = '60px';
            img.style.height = '60px';
            img.style.borderRadius = '8px';

            const right = document.createElement('div');
            const title = document.createElement('div');
            title.textContent = `${item.trackName || ''} Â· ${item.artistName || ''}`;
            title.style.fontSize = '14px';
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.style.width = '100%';
            if(item.previewUrl){
              audio.src = item.previewUrl;
            }
            const link = document.createElement('a');
            link.href = item.trackViewUrl || '#';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = 'åœ¨ Apple Music æŸ¥çœ‹';
            link.style.display = 'inline-block';
            link.style.marginTop = '4px';

            right.appendChild(title);
            right.appendChild(audio);
            right.appendChild(link);

            row.appendChild(img);
            row.appendChild(right);
            frag.appendChild(row);
          });
          div.innerHTML = '';
          div.appendChild(frag);
        }else{
          const err = (j && j.error) ? j.error : 'éŸ³ä¹æœç´¢å¤±è´¥';
          div.innerText = `ç³»ç»Ÿ ${ts}\n${err}`;
        }
        box.scrollTop = box.scrollHeight;
      }).catch(()=>{
        div.innerText = `ç³»ç»Ÿ ${ts}\néŸ³ä¹æœç´¢æœåŠ¡ä¸å¯ç”¨`;
        box.scrollTop = box.scrollHeight;
      });
    }

    // ---------- News ----------
    function startNews(){
      const box = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'bubble other';
      const ts = new Date().toLocaleTimeString();
      div.innerText = `ç³»ç»Ÿ ${ts}\næ–°é—»è·å–ä¸­â€¦`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;

      const base = window.location.origin;
      const url = `${base}/feature/news`;
      fetch(url).then(r=>r.json()).then(j=>{
        if(j && j.ok){
          const list = j.results || [];
          const frag = document.createDocumentFragment();
          const header = document.createElement('div');
          header.textContent = `ç³»ç»Ÿ ${ts} Â· å¾®åšçƒ­æ¦œTop${list.length}`;
          frag.appendChild(header);
          list.forEach(item => {
            const row = document.createElement('div');
            const a = document.createElement('a');
            a.href = item.url || '#';
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.textContent = `${item.index ?? ''}. ${item.title ?? ''}`;
            const hot = document.createElement('span');
            hot.textContent = item.hot ? `ï¼ˆçƒ­åº¦ï¼š${item.hot}ï¼‰` : '';
            hot.style.marginLeft = '6px';
            row.appendChild(a);
            row.appendChild(hot);
            frag.appendChild(row);
          });
          div.innerHTML = '';
          div.appendChild(frag);
        }else{
          const err = (j && j.error) ? j.error : 'æ–°é—»è·å–å¤±è´¥';
          div.innerText = `ç³»ç»Ÿ ${ts}\n${err}`;
        }
        box.scrollTop = box.scrollHeight;
      }).catch(()=>{
        div.innerText = `ç³»ç»Ÿ ${ts}\næ–°é—»æœåŠ¡ä¸å¯ç”¨`;
        box.scrollTop = box.scrollHeight;
      });
    }

    // ---------- Short Video ----------
    function startShortVideo(){
      const box = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'bubble other';
      const ts = new Date().toLocaleTimeString();
      div.innerText = `ç³»ç»Ÿ ${ts}\nå°è§†é¢‘è·å–ä¸­â€¦`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;

      const base = window.location.origin;
      const url = `${base}/feature/video`;
      fetch(url).then(r=>r.json()).then(j=>{
        if(j && j.ok){
          const videoUrl = j.videoUrl;
          const frag = document.createDocumentFragment();
          const header = document.createElement('div');
          header.textContent = `ç³»ç»Ÿ ${ts}`;
          frag.appendChild(header);
          const video = document.createElement('video');
          video.controls = true;
          video.style.width = '100%';
          if(videoUrl){
            video.src = videoUrl;
          }
          const link = document.createElement('a');
          link.href = videoUrl || '#';
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = 'æ‰“å¼€åŸè§†é¢‘';
          link.style.display = 'inline-block';
          link.style.marginTop = '6px';
          frag.appendChild(video);
          frag.appendChild(link);
          div.innerHTML = '';
          div.appendChild(frag);
        }else{
          const err = (j && j.error) ? j.error : 'å°è§†é¢‘è·å–å¤±è´¥';
          div.innerText = `ç³»ç»Ÿ ${ts}\n${err}`;
        }
        box.scrollTop = box.scrollHeight;
      }).catch(()=>{
        div.innerText = `ç³»ç»Ÿ ${ts}\nå°è§†é¢‘æœåŠ¡ä¸å¯ç”¨`;
        box.scrollTop = box.scrollHeight;
      });
    }
  </script>
</body>
</html>
